<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeu de DÃ©fis Consentis</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px;touch-action:none}
.container{background:#fff;border-radius:15px;padding:20px;max-width:500px;width:100%;box-shadow:0 5px 20px rgba(0,0,0,.3)}
.language-selector{display:flex;gap:8px;justify-content:center;margin-bottom:15px}
.language-option{width:35px;height:35px;border:2px solid #e0e0e0;border-radius:50%;cursor:pointer;transition:all .2s;background:#fff;display:flex;align-items:center;justify-content:center}
.language-option:hover{border-color:#667eea;transform:scale(1.1)}
.language-option.selected{border-color:#667eea;background:#667eea}
.language-flag{font-size:1.3em}
h1{color:#667eea;text-align:center;margin-bottom:15px;font-size:1.5em}
.screen{display:none}
.screen.active{display:block}
.input-group{margin-bottom:10px}
label{display:block;margin-bottom:5px;color:#333;font-weight:600}
input[type=number]{width:100%;padding:8px;border:2px solid#e0e0e0;border-radius:6px;font-size:14px;text-align:center}
input[type=number]:focus{outline:0;border-color:#667eea}
button{background:#667eea;color:#fff;border:0;padding:10px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;width:100%;margin-top:10px;transition:background .2s}
button:hover{background:#5568d3}
button:disabled{background:#ccc;cursor:not-allowed}
.challenge-card{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;padding:20px;border-radius:8px;text-align:center;margin:15px 0;font-size:1.1em;min-height:120px;display:flex;align-items:center;justify-content:center}
.consent-options{display:flex;gap:8px;margin-top:15px}
.consent-btn{flex:1;padding:12px;font-size:14px;border-radius:6px;transition:transform .2s}
.consent-btn:hover{transform:scale(1.05)}
.consent-yes{background:#4caf50}
.consent-yes:hover{background:#45a049}
.consent-no{background:#f44336}
.consent-no:hover{background:#da190b}
.instruction{text-align:center;font-size:.9em;color:#666;margin:10px 0;padding:8px;background:#f5f5f5;border-radius:6px}
.warning{background:#fff3cd;color:#856404;padding:8px;border-radius:6px;margin-bottom:10px;border-left:3px solid #ffc107}
.result-card{padding:20px;border-radius:8px;text-align:center;margin:15px 0;font-size:1.1em;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.result-accepted{background:linear-gradient(135deg,#4caf50,#45a049);color:#fff}
.result-refused{background:linear-gradient(135deg,#f44336,#da190b);color:#fff}
.counter{font-size:1.8em;font-weight:700;color:#667eea;text-align:center;margin:10px 0}
.info{text-align:center;color:#666;margin-top:10px;font-size:.8em}
.intensity-selector{display:flex;gap:8px;justify-content:center;margin:10px 0}
.intensity-option{width:40px;height:40px;border:2px solid #e0e0e0;border-radius:50%;cursor:pointer;transition:all .2s;background:#fff;display:flex;align-items:center;justify-content:center;position:relative}
.intensity-option:hover{border-color:#667eea;background:#f8f9ff;transform:scale(1.1)}
.intensity-option.selected{border-color:#667eea;background:#667eea;transform:scale(1.15)}
.intensity-icon{font-size:1.3em}
.intensity-name{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:.7em;color:#667eea;opacity:0;transition:opacity .2s}
.intensity-option:hover .intensity-name{opacity:1}
.touch-area{position:relative;width:100%;height:300px;background:#f5f5f5;border-radius:8px;margin:15px 0}
.finger{position:absolute;width:60px;height:60px;border-radius:50%;background:#FF6B6B;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2em;font-weight:700;transform:translate(-50%,-50%);box-shadow:0 3px 8px rgba(0,0,0,.3);transition:all .3s}
.finger.loser{opacity:.6}
.finger.winner{background:#4CAF50;width:80px;height:80px;font-size:1.5em;animation:winnerPulse 1s infinite;box-shadow:0 0 15px rgba(76,175,80,.8)}
@keyframes winnerPulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.1)}}
.countdown-display{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8em;color:#667eea;font-weight:700;z-index:10;animation:countdownPulse 1s infinite}
@keyframes countdownPulse{0%,100%{scale:1;opacity:1}50%{scale:1.1;opacity:.8}}
</style>
</head>
<body>
<div class="container">
  <div class="language-selector">
    <div class="language-option selected" data-lang="fr" onclick="selectLanguage('fr')"><span class="language-flag">ðŸ‡«ðŸ‡·</span></div>
    <div class="language-option" data-lang="en" onclick="selectLanguage('en')"><span class="language-flag">ðŸ‡¬ðŸ‡§</span></div>
  </div>
  <h1 id="mainTitle">ðŸŽ­ Jeu de DÃ©fis Consentis</h1>

  <div class="screen active" id="setupScreen">
    <div class="warning" id="warningText">âš  Jeu pour adultes consentants 18+</div>
    <div class="input-group">
      <label for="intensity" id="intensityLabel">IntensitÃ©:</label>
      <div class="intensity-selector">
        <div class="intensity-option" data-level="soft" onclick="selectIntensity('soft')">
          <span class="intensity-icon">ðŸ˜Š</span>
          <span class="intensity-name" id="intensitySoftName">Doux</span>
        </div>
        <div class="intensity-option" data-level="medium" onclick="selectIntensity('medium')">
          <span class="intensity-icon">ðŸ”¥</span>
          <span class="intensity-name" id="intensityMediumName">Chaud</span>
        </div>
        <div class="intensity-option" data-level="hot" onclick="selectIntensity('hot')">
          <span class="intensity-icon">ðŸŒ¶</span>
          <span class="intensity-name" id="intensityHotName">Torride</span>
        </div>
      </div>
    </div>
    <div class="input-group">
      <label for="playerCount" id="playerCountLabel">Participants:</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <button type="button" onclick="adjustPlayerCount(-1)" style="width:30px;height:30px;background:#f0f0f0;border:1px solid #ccc;border-radius:6px;">âˆ’</button>
        <input type="number" id="playerCount" value="2" min="2" max="20">
        <button type="button" onclick="adjustPlayerCount(1)" style="width:30px;height:30px;background:#f0f0f0;border:1px solid #ccc;border-radius:6px;">+</button>
      </div>
    </div>
    <button onclick="startGame()" id="startBtn" disabled>Commencer</button>
    <div class="info" id="infoAnonymous">Smartphone circule anonymement</div>
  </div>

  <div class="screen" id="challengeScreen">
    <div class="challenge-card" id="challengeText"></div>
    <div class="instruction" id="passPhoneText">Passez le tÃ©lÃ©phone Ã  chaque participant</div>
    <button onclick="startVoting()" id="startVotingBtn">Lancer le vote</button>
  </div>

  <div class="screen" id="votingScreen">
    <div class="counter" id="voteCounter"></div>
    <div class="instruction" id="votingInstruction"><strong>RÃ©pondez en secret</strong><br>Acceptez-vous?</div>
    <div class="consent-options">
      <button class="consent-btn consent-yes" onclick="vote(true)" id="acceptBtn">âœ“ Accepter</button>
      <button class="consent-btn consent-no" onclick="vote(false)" id="refuseBtn">âœ— Refuser</button>
    </div>
  </div>

  <div class="screen" id="resultScreen">
    <div id="resultDisplay" class="result-card"></div>
    <button onclick="startSelection()" id="selectProtBtn" style="display:none">SÃ©lectionner protagonistes</button>
    <button onclick="nextRound()" id="nextBtn">Prochain dÃ©fi</button>
    <button onclick="resetGame()" id="newGameBtn" style="background:#f44336">Nouvelle partie</button>
  </div>

  <div class="screen" id="selectionScreen">
    <div class="instruction" id="selectionInstruction">Posez un doigt sur l'Ã©cran</div>
    <div class="touch-area" id="touchArea"></div>
    <button onclick="startSelectionCountdown()" id="selectionBtn" disabled>Lancer sÃ©lection</button>
    <button onclick="nextRound()" id="continueBtn" style="display:none">Continuer</button>
  </div>

  <div class="info" id="infoConsent">Consentement rÃ©vocable Ã  tout moment</div>
</div>

<script>
let playerCount = 0;
let currentChallenge = null;
let currentVote = 0;
let allAccepted = true;
let selectedIntensity = null;
let selectedLanguage = 'fr';
let usedChallenges = [];
let touches = [];

const translations = {
  fr: {
    title: "ðŸŽ­ Jeu de DÃ©fis Consentis",
    warning: "âš  Jeu pour adultes consentants 18+",
    intensityLabel: "IntensitÃ©:",
    intensitySoft: "Doux",
    intensityMedium: "Chaud",
    intensityHot: "Torride",
    playerCountLabel: "Participants:",
    startBtn: "Commencer",
    infoAnonymous: "Smartphone circule anonymement",
    passPhone: "Passez le tÃ©lÃ©phone Ã  chaque participant",
    startVoting: "Lancer le vote",
    participant: "RÃ©pondez en secret",
    acceptQuestion: "Acceptez-vous?",
    acceptBtn: "âœ“ Accepter",
    refuseBtn: "âœ— Refuser",
    challengeAccepted: "DÃ‰FI ACCEPTÃ‰!",
    allAgree: "Tous d'accord",
    challengeRefused: "DÃ‰FI REFUSÃ‰",
    someoneRefused: "Quelqu'un refuse",
    consentNeeded: "Consentement requis",
    challengeToComplete: "DÃ©fi:",
    nextChallenge: "Prochain dÃ©fi",
    newGame: "Nouvelle partie",
    infoConsent: "Consentement rÃ©vocable Ã  tout moment",
    selectIntensity: "Choisir une intensitÃ©!",
    minPlayers: "Minimum 2 participants!",
    selectProt: "SÃ©lectionner protagonistes",
    selectionInstr: "Posez un doigt sur l'Ã©cran",
    launchSelect: "Lancer sÃ©lection"
  },
  en: {
    title: "ðŸŽ­ Challenge Game",
    warning: "âš  For consenting adults 18+",
    intensityLabel: "Intensity:",
    intensitySoft: "Soft",
    intensityMedium: "Hot",
    intensityHot: "Spicy",
    playerCountLabel: "Players:",
    startBtn: "Start",
    infoAnonymous: "Phone circulates anonymously",
    passPhone: "Pass phone to each player",
    startVoting: "Start voting",
    participant: "Answer privately",
    acceptQuestion: "Accept challenge?",
    acceptBtn: "âœ“ Accept",
    refuseBtn: "âœ— Refuse",
    challengeAccepted: "CHALLENGE ACCEPTED!",
    allAgree: "All agree",
    challengeRefused: "CHALLENGE REFUSED",
    someoneRefused: "Someone disagrees",
    consentNeeded: "Full consent needed",
    challengeToComplete: "Challenge:",
    nextChallenge: "Next challenge",
    newGame: "New game",
    infoConsent: "Consent can be withdrawn anytime",
    selectIntensity: "Select intensity!",
    minPlayers: "Minimum 2 players!",
    selectProt: "Select protagonists",
    selectionInstr: "Place a finger on screen",
    launchSelect: "Launch selection"
  }
};

const challenges = {
  soft: {
    fr: [
      { t: "Massez les Ã©paules de la personne Ã  votre gauche 30s", n: 2 },
      { t: "Compliment sincÃ¨re Ã  tous", n: 1 },
      { t: "Dansez suggestivement 30s", n: 1 }
    ],
    en: [
      { t: "Massage shoulders of person on left 30s", n: 2 },
      { t: "Sincere compliment to all", n: 1 },
      { t: "Dance suggestively 30s", n: 1 }
    ]
  },
  medium: {
    fr: [
      { t: "Embrassez la joue de la personne Ã  droite", n: 2 },
      { t: "Racontez une anecdote romantique", n: 1 },
      { t: "Clin d'Å“il charmeur Ã  tous", n: 1 }
    ],
    en: [
      { t: "Kiss cheek of person on right", n: 2 },
      { t: "Share romantic anecdote", n: 1 },
      { t: "Charming wink to all", n: 1 }
    ]
  },
  hot: {
    fr: [
      { t: "Chuchotez phrase sÃ©ductrice", n: 2 },
      { t: "Danse sensuelle Ã  deux", n: 2 },
      { t: "Partagez un fantasme respectueux", n: 1 }
    ],
    en: [
      { t: "Whisper seductive phrase", n: 2 },
      { t: "Sensual dance with partner", n: 2 },
      { t: "Share respectful fantasy", n: 1 }
    ]
  }
};

function selectLanguage(lang) {
  selectedLanguage = lang;
  document.querySelectorAll('.language-option').forEach(opt =>
    opt.classList.toggle('selected', opt.dataset.lang === lang)
  );
  updateInterface();
}

function selectIntensity(level) {
  selectedIntensity = level;
  document.querySelectorAll('.intensity-option').forEach(opt =>
    opt.classList.toggle('selected', opt.dataset.level === level)
  );
  updateStartButton();
}

function adjustPlayerCount(delta) {
  const input = document.getElementById('playerCount');
  let value = parseInt(input.value) || 2;
  value += delta;
  if (value < 2) value = 2;
  if (value > 20) value = 20;
  input.value = value;
  updateStartButton();
}

function updateStartButton() {
  const startBtn = document.getElementById('startBtn');
  const playerInput = document.getElementById('playerCount'); // âœ… sans espace
  playerCount = parseInt(playerInput.value) || 0;
  if (playerCount < 2 || playerCount > 20) {
    playerInput.value = 2;
    playerCount = 2;
  }
  startBtn.disabled = !selectedIntensity || playerCount < 2;
}

function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen =>
    screen.classList.toggle('active', screen.id === screenId)
  );
}

function getRandomChallenge() {
  let challengeList = challenges[selectedIntensity]?.[selectedLanguage] || [];
  if (!challengeList.length) {
    alert(translations[selectedLanguage].selectIntensity);
    return null;
  }
  challengeList = challengeList.filter(c => !usedChallenges.includes(c.t));
  if (!challengeList.length) {
    usedChallenges = [];
    challengeList = challenges[selectedIntensity][selectedLanguage];
  }
  const randomIndex = Math.floor(Math.random() * challengeList.length);
  const challenge = challengeList[randomIndex];
  usedChallenges.push(challenge.t);
  return challenge;
}

function updateInterface() {
  const t = translations[selectedLanguage];
  document.getElementById('mainTitle').textContent = t.title;
  document.getElementById('warningText').textContent = t.warning;
  document.getElementById('intensityLabel').textContent = t.intensityLabel;
  document.getElementById('intensitySoftName').textContent = t.intensitySoft;
  document.getElementById('intensityMediumName').textContent = t.intensityMedium;
  document.getElementById('intensityHotName').textContent = t.intensityHot;
  document.getElementById('playerCountLabel').textContent = t.playerCountLabel; // âœ…
  document.getElementById('startBtn').textContent = t.startBtn;
  document.getElementById('infoAnonymous').textContent = t.infoAnonymous;
  document.getElementById('passPhoneText').textContent = t.passPhone; // âœ…
  document.getElementById('startVotingBtn').textContent = t.startVoting;
  document.getElementById('votingInstruction').innerHTML = `<strong>${t.participant}</strong><br>${t.acceptQuestion}`;
  document.getElementById('acceptBtn').textContent = t.acceptBtn;
  document.getElementById('refuseBtn').textContent = t.refuseBtn;
  document.getElementById('nextBtn').textContent = t.nextChallenge;
  document.getElementById('newGameBtn').textContent = t.newGame;
  document.getElementById('infoConsent').textContent = t.infoConsent;
  document.getElementById('selectProtBtn').textContent = t.selectProt;
  document.getElementById('selectionInstruction').textContent = t.selectionInstr;
  document.getElementById('selectionBtn').textContent = t.launchSelect;
}

function startGame() {
  playerCount = parseInt(document.getElementById('playerCount').value) || 0; // âœ…
  if (playerCount < 2 || playerCount > 20) {
    alert(translations[selectedLanguage].minPlayers);
    document.getElementById('playerCount').value = 2; // âœ…
    playerCount = 2;
    return;
  }
  if (!selectedIntensity) {
    alert(translations[selectedLanguage].selectIntensity);
    return;
  }
  currentChallenge = getRandomChallenge();
  if (!currentChallenge) return;
  document.getElementById('challengeText').textContent = currentChallenge.t;
  currentVote = 0;
  allAccepted = true;
  showScreen('challengeScreen');
}

function startVoting() {
  currentVote = 0;
  allAccepted = true;
  document.getElementById('voteCounter').textContent = `0/${playerCount}`;
  showScreen('votingScreen');
}

function vote(accepted) {
  currentVote++;
  if (!accepted) allAccepted = false;
  document.getElementById('voteCounter').textContent = `${currentVote}/${playerCount}`;
  if (currentVote < playerCount) return;
  showScreen('resultScreen');
  const resultDisplay = document.getElementById('resultDisplay'); // âœ…
  resultDisplay.className = `result-card ${allAccepted ? 'result-accepted' : 'result-refused'}`;
  resultDisplay.innerHTML = allAccepted
    ? `<h3>${translations[selectedLanguage].challengeAccepted}</h3><p>${translations[selectedLanguage].allAgree}</p><p>${translations[selectedLanguage].challengeToComplete} ${currentChallenge.t}</p>`
    : `<h3>${translations[selectedLanguage].challengeRefused}</h3><p>${translations[selectedLanguage].someoneRefused}</p><p>${translations[selectedLanguage].consentNeeded}</p>`;
  document.getElementById('selectProtBtn').style.display = allAccepted && currentChallenge && currentChallenge.n > 0 ? 'block' : 'none';
  document.getElementById('nextBtn').style.display = allAccepted && currentChallenge && currentChallenge.n === 0 ? 'block' : 'none';
}

function nextRound() {
  currentChallenge = getRandomChallenge();
  if (!currentChallenge) return;
  document.getElementById('challengeText').textContent = currentChallenge.t;
  showScreen('challengeScreen');
}

function resetGame() {
  playerCount = 0;
  currentChallenge = null;
  currentVote = 0;
  allAccepted = true;
  selectedIntensity = null;
  usedChallenges = [];
  touches = [];
  document.getElementById('playerCount').value = 2; // âœ…
  document.querySelectorAll('.intensity-option').forEach(opt => opt.classList.remove('selected'));
  showScreen('setupScreen');
  updateStartButton();
}

function startSelection() {
  showScreen('selectionScreen');
  touches = [];
  renderFingers();
  document.getElementById('selectionBtn').disabled = true;
  document.getElementById('continueBtn').style.display = 'none';
  document.getElementById('selectionBtn').style.display = 'block';
}

const touchArea = document.getElementById('touchArea');

touchArea.addEventListener('touchstart', e => {
  e.preventDefault();
  updateTouches(e.touches);
});
touchArea.addEventListener('touchmove', e => {
  e.preventDefault();
  updateTouches(e.touches);
});
touchArea.addEventListener('touchend', e => {
  e.preventDefault();
  updateTouches(e.touches);
});

function updateTouches(touchList) {
  const rect = touchArea.getBoundingClientRect();
  touches = Array.from(touchList).map((t, i) => ({
    id: t.identifier,
    x: t.clientX - rect.left,
    y: t.clientY - rect.top,
    number: i + 1
  }));
  renderFingers();
  document.getElementById('selectionBtn').disabled = !currentChallenge || touches.length < currentChallenge.n;
}

function renderFingers() {
  touchArea.innerHTML = '';
  touches.forEach(t => {
    const finger = document.createElement('div');
    finger.classList.add('finger');
    finger.style.left = `${t.x}px`;
    finger.style.top = `${t.y}px`;
    finger.textContent = t.number;
    touchArea.appendChild(finger);
  });
}

function startSelectionCountdown() {
  let count = 5;
  const cdDisplay = document.createElement('div');
  cdDisplay.classList.add('countdown-display'); // âœ…
  touchArea.appendChild(cdDisplay);
  const interval = setInterval(() => {
    cdDisplay.textContent = count;
    count--;
    if (count < 0) {
      clearInterval(interval);
      cdDisplay.remove();
      selectProtagonists();
    }
  }, 1000);
}

function selectProtagonists() {
  if (!currentChallenge) return;
  const num = currentChallenge.n;
  if (touches.length < num) {
    alert(translations[selectedLanguage].minPlayers);
    return;
  }
  let candidates = [...touches];
  const winners = [];
  for (let i = 0; i < num; i++) {
    const rand = Math.floor(Math.random() * candidates.length);
    winners.push(candidates[rand]);
    candidates.splice(rand, 1);
  }
  document.querySelectorAll('.finger').forEach(f =
