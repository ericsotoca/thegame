<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Jeu de Défis Consentis v6 - Multilingue</title>
<style>
    /* ═══════════════════════════════════════════════════════════════
       STYLES GLOBAUX
       ═══════════════════════════════════════════════════════════════ */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px;touch-action:none;overflow:hidden}
    .container{background:#fff;border-radius:15px;padding:20px;max-width:500px;width:100%;box-shadow:0 5px 20px rgba(0,0,0,.3);position:relative}
    /* ═══════════════════════════════════════════════════════════════
       BOUTON RETOUR ACCUEIL
       ═══════════════════════════════════════════════════════════════ */
    #homeBtn {
        position: fixed;
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        border: 2px solid #667eea;
        font-size: 1.5em;
        cursor: pointer;
        z-index: 1000;
        display: none; /* Caché par défaut, géré par JS */
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        padding: 0;
        margin: 0;
    }
    #homeBtn:hover {
        transform: scale(1.1);
        background: white;
    }
    /* ═══════════════════════════════════════════════════════════════
       BOUTON SÉLECTION PROTAGONISTE
       ═══════════════════════════════════════════════════════════════ */
    #selectProtagonistBtn {
        position: fixed;
        bottom: 15px;
        right: 15px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        border: 2px solid #667eea;
        font-size: 1.5em;
        cursor: pointer;
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        transition: all 0.2s ease;
        padding: 0;
        margin: 0;
    }
    #selectProtagonistBtn:hover {
        transform: scale(1.1);
        background: white;
    }
    /* ═══════════════════════════════════════════════════════════════
       DÉCOMPTE VISIBLE
       ═══════════════════════════════════════════════════════════════ */
    .countdown-display {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 120px;
        font-weight: bold;
        color: rgba(102, 126, 234, 0.9);
        text-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        pointer-events: none;
    }
    /* ═══════════════════════════════════════════════════════════════
       ÉLÉMENTS D'INTERFACE COMMUNS
       ═══════════════════════════════════════════════════════════════ */
    h1{color:#667eea;text-align:center;margin-bottom:15px;font-size:1.5em}
    .screen{display:none}
    .screen.active{display:block}
    button{background:#667eea;color:#fff;border:0;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:10px;transition:all .2s ease}
    button:hover{background:#5568d3;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.2)}
    button:disabled{background:#ccc;cursor:not-allowed;transform:none;box-shadow:none}
    .instruction{text-align:center;font-size:1em;color:#666;margin:15px 0;padding:10px;background:#f5f5f5;border-radius:6px}
    .info{text-align:center;color:#666;margin-top:10px;font-size:.8em}
    .button-group { display: flex; gap: 10px; }
    .button-group button { flex: 1; }
    /* ═══════════════════════════════════════════════════════════════
       ÉCRAN DE CONFIGURATION (SETUP)
       ═══════════════════════════════════════════════════════════════ */
    .language-selector{display:flex;gap:8px;justify-content:center;margin-bottom:15px}
    .language-option{width:35px;height:35px;border:2px solid #e0e0e0;border-radius:50%;cursor:pointer;transition:all .2s;background:#fff;display:flex;align-items:center;justify-content:center}
    .language-option:hover{border-color:#667eea;transform:scale(1.1)}
    .language-option.selected{border-color:#667eea;background:#667eea}
    .language-flag{font-size:1.3em}
    .input-group{margin-bottom:15px}
    label{display:block;margin-bottom:5px;color:#333;font-weight:600}
    input[type=number]{width:100%;padding:8px;border:2px solid#e0e0e0;border-radius:6px;font-size:14px;text-align:center}
    input[type=number]:focus{outline:0;border-color:#667eea}
    .warning{background:#fff3cd;color:#856404;padding:8px;border-radius:6px;margin-bottom:10px;border-left:3px solid #ffc107}
    .intensity-selector{display:flex;gap:8px;justify-content:center;margin:10px 0}
    .intensity-option{width:40px;height:40px;border:2px solid #e0e0e0;border-radius:50%;cursor:pointer;transition:all .2s;background:#fff;display:flex;align-items:center;justify-content:center;position:relative}
    .intensity-option:hover{border-color:#667eea;background:#f8f9ff;transform:scale(1.1)}
    .intensity-option.selected{border-color:#667eea;background:#667eea;transform:scale(1.15)}
    .intensity-icon{font-size:1.3em}
    .intensity-name{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:.7em;color:#667eea;opacity:0;transition:opacity .2s}
    .intensity-option:hover .intensity-name{opacity:1}
    /* ═══════════════════════════════════════════════════════════════
       ÉCRANS DE JEU (DÉFI, VOTE, RÉSULTAT)
       ═══════════════════════════════════════════════════════════════ */
    .challenge-card{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;padding:20px;border-radius:8px;text-align:center;margin:15px 0;font-size:1.1em;min-height:120px;display:flex;align-items:center;justify-content:center}
    .consent-options{display:flex;gap:8px;margin-top:15px}
    .consent-btn{flex:1;padding:12px;font-size:14px;border-radius:6px;color:white!important}
    .consent-yes{background:#4caf50}
    .consent-yes:hover{background:#45a049}
    .consent-no{background:#f44336}
    .consent-no:hover{background:#da190b}
    .result-card{padding:20px;border-radius:8px;text-align:center;margin:15px 0;font-size:1.1em;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .result-accepted{background:linear-gradient(135deg,#81fbb8,#28c76f);color:#fff}
    .result-refused{background:linear-gradient(135deg,#f8_8_3_8_6,#ea5455);color:#fff}
    .counter{font-size:1.8em;font-weight:700;color:#667eea;text-align:center;margin:10px 0}
    /* ═══════════════════════════════════════════════════════════════
       ÉCRAN DE SÉLECTION
       ═══════════════════════════════════════════════════════════════ */
    .touch-area{position:relative;width:100%;height:350px;background:#f0f0f0;border-radius:8px;margin:15px 0;overflow:hidden}
    .finger{position:absolute;width:80px;height:80px;border-radius:50%;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;color:white;font-size:2rem;font-weight:bold;pointer-events:none;transition:all .3s ease;box-shadow:0 4px 15px rgba(0,0,0,.3);background:#FF6B6B}
    .finger.loser{opacity:.5;background:#FF6B6B!important}
    .finger.winner{animation:winnerPulse 1s ease-in-out infinite;width:100px;height:100px;font-size:3rem;z-index:100;box-shadow:0 0 30px rgba(76,175,80,.8);background:#4CAF50!important}
    @keyframes winnerPulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.1)}}
</style>
</head>
<body>
<button id="homeBtn" onclick="resetGame()" title="Retour à l'accueil">🏠</button>
<button id="selectProtagonistBtn" onclick="startSelectionFromButton()" title="Sélectionner un protagoniste">👆</button>
<div class="container">
  <div class="language-selector">
    <div class="language-option selected" data-lang="fr" onclick="selectLanguage('fr')"><span class="language-flag">🇫🇷</span></div>
    <div class="language-option" data-lang="en" onclick="selectLanguage('en')"><span class="language-flag">🇬🇧</span></div>
    <div class="language-option" data-lang="pt" onclick="selectLanguage('pt')"><span class="language-flag">🇵🇹</span></div>
  </div>
  <h1 id="mainTitle"></h1>
  <div class="screen active" id="setupScreen">
    <div class="warning" id="warningText"></div>
    <div class="input-group">
      <label for="intensity" id="intensityLabel"></label>
      <div class="intensity-selector">
        <div class="intensity-option" data-level="soft" onclick="selectIntensity('soft')"><span class="intensity-icon">😊</span><span class="intensity-name" id="intensitySoftName"></span></div>
        <div class="intensity-option" data-level="medium" onclick="selectIntensity('medium')"><span class="intensity-icon">🔥</span><span class="intensity-name" id="intensityMediumName"></span></div>
        <div class="intensity-option" data-level="hot" onclick="selectIntensity('hot')"><span class="intensity-icon">🌶</span><span class="intensity-name" id="intensityHotName"></span></div>
      </div>
    </div>
    <div class="input-group">
      <label for="playerCount" id="playerCountLabel"></label>
      <div style="display:flex;gap:8px;align-items:center;">
        <button type="button" onclick="adjustPlayerCount(-1)" style="width:40px;height:40px;background:#f0f0f0;border:1px solid #ccc;border-radius:50%;color:#333;font-size:1.5em">−</button>
        <input type="number" id="playerCount" value="2" min="2" max="20">
        <button type="button" onclick="adjustPlayerCount(1)" style="width:40px;height:40px;background:#f0f0f0;border:1px solid #ccc;border-radius:50%;color:#333;font-size:1.5em">+</button>
      </div>
    </div>
    <button onclick="startGame()" id="startBtn" disabled></button>
    <div class="info" id="infoAnonymous"></div>
  </div>
  <div class="screen" id="challengeScreen">
    <div class="challenge-card" id="challengeText"></div>
    <div class="instruction" id="passPhoneText"></div>
    <button onclick="startVoting()" id="startVotingBtn"></button>
  </div>
  <div class="screen" id="votingScreen">
    <div class="counter" id="voteCounter"></div>
    <div class="instruction" id="votingInstruction"></div>
    <div class="consent-options">
      <button class="consent-btn consent-yes" onclick="vote(true)" id="acceptBtn"></button>
      <button class="consent-btn consent-no" onclick="vote(false)" id="refuseBtn"></button>
    </div>
  </div>
  <div class="screen" id="resultScreen">
    <div id="resultDisplay" class="result-card"></div>
    <button onclick="startSelection()" id="selectProtBtn" style="display:none"></button>
    <button onclick="nextRound()" id="nextBtn"></button>
    <button onclick="resetGame()" id="newGameBtn" style="background:#f44336"></button>
  </div>
  <div class="screen" id="selectionScreen">
    <div class="instruction" id="selectionInstruction"></div>
    <div class="touch-area" id="touchArea"></div>
    <div id="selectionActionBtnGroup" class="button-group" style="display:none">
      <button id="selectAnotherProtagonistBtn" style="display:none"></button>
      <button id="continueToNextChallengeBtn" style="display:none"></button>
    </div>
  </div>
  <div class="info" id="infoConsent"></div>
</div>
<script>
// --- VARIABLES GLOBALES ---
let playerCount = 2;
let currentChallenge = null;
let currentVote = 0;
let allAccepted = true;
let selectedIntensity = null;
let selectedLanguage = 'fr';
let usedChallenges = [];
let touches = [];
let countdownTimer = null;
let countdownDisplay = null;
let protagonistsToSelect = 0;
let selectedProtagonists = [];
const touchArea = document.getElementById('touchArea');
const selectionActionBtnGroup = document.getElementById('selectionActionBtnGroup');
const selectAnotherProtagonistBtn = document.getElementById('selectAnotherProtagonistBtn');
const continueToNextChallengeBtn = document.getElementById('continueToNextChallengeBtn');
// --- DONNÉES DU JEU (TRADUCTIONS & DÉFIS) ---
const translations = {
  fr: {
    title: "🎭 Jeu de Défis Consentis",
    warning: "⚠ Jeu pour adultes consentants (18+).",
    intensityLabel: "Intensité :",
    intensitySoft: "Doux",
    intensityMedium: "Chaud",
    intensityHot: "Torride",
    playerCountLabel: "Participants :",
    startBtn: "Commencer la Partie",
    infoAnonymous: "Le smartphone circule de manière anonyme pour les votes.",
    passPhone: "Passez le téléphone à chaque participant pour le vote.",
    startVoting: "Lancer le Vote Anonyme",
    participant: "Répondez en secret",
    acceptQuestion: "Acceptez-vous ce défi ?",
    acceptBtn: "✓ Accepter",
    refuseBtn: "✗ Refuser",
    challengeAccepted: "🎉 DÉFI ACCEPTÉ ! 🎉",
    allAgree: "Tout le monde est d'accord.",
    challengeRefused: "DÉFI REFUSÉ",
    someoneRefused: "Au moins une personne a refusé.",
    consentNeeded: "Le consentement de tous est requis.",
    challengeToComplete: "Défi à réaliser :",
    nextChallenge: "Prochain Défi",
    newGame: "Nouvelle Partie",
    infoConsent: "Le consentement peut être retiré à tout moment.",
    selectIntensity: "Veuillez choisir une intensité pour commencer !",
    minPlayers: "Il faut au moins 2 participants !",
    selectProt: "Sélectionner les protagonistes",
    selectionInstr: "Posez vos doigts sur l'écran !",
    selectionInstrInProgress: "Gardez vos doigts en place...",
    selectProtagonistOf: "Sélection du protagoniste {current} sur {total}",
    selectNextProt: "Sélectionner le suivant",
    continue: "Continuer",
    minPlayersForSelection: "Il faut au moins 1 doigt sur l'écran !",
    selectAnotherProtagonist: "Autre protagoniste",
    continueToNextChallenge: "Nouveau défi"
  },
  en: {
    title: "🎭 Consent Challenge Game",
    warning: "⚠ Game for consenting adults (18+).",
    intensityLabel: "Intensity:",
    intensitySoft: "Soft",
    intensityMedium: "Hot",
    intensityHot: "Spicy",
    playerCountLabel: "Players:",
    startBtn: "Start Game",
    infoAnonymous: "The phone is passed around anonymously for voting.",
    passPhone: "Pass the phone to each player for the vote.",
    startVoting: "Start Anonymous Voting",
    participant: "Answer secretly",
    acceptQuestion: "Do you accept this challenge?",
    acceptBtn: "✓ Accept",
    refuseBtn: "✗ Refuse",
    challengeAccepted: "🎉 CHALLENGE ACCEPTED! 🎉",
    allAgree: "Everyone agreed.",
    challengeRefused: "CHALLENGE REFUSED",
    someoneRefused: "At least one person refused.",
    consentNeeded: "Full consent from everyone is required.",
    challengeToComplete: "Challenge to perform:",
    nextChallenge: "Next Challenge",
    newGame: "New Game",
    infoConsent: "Consent can be withdrawn at any time.",
    selectIntensity: "Please select an intensity to start!",
    minPlayers: "A minimum of 2 players is required!",
    selectProt: "Select Protagonists",
    selectionInstr: "Place your fingers on the screen!",
    selectionInstrInProgress: "Keep your fingers in place...",
    selectProtagonistOf: "Selecting protagonist {current} of {total}",
    selectNextProt: "Select Next",
    continue: "Continue",
    minPlayersForSelection: "At least 1 finger is required on screen!",
    selectAnotherProtagonist: "Another Protagonist",
    continueToNextChallenge: "Next Challenge"
  },
  pt: {
    title: "🎭 Jogo de Desafios Consentidos",
    warning: "⚠ Jogo para adultos (18+). É necessário consentimento.",
    intensityLabel: "Intensidade:",
    intensitySoft: "Leve",
    intensityMedium: "Quente",
    intensityHot: "Ardente",
    playerCountLabel: "Participantes:",
    startBtn: "Começar o Jogo",
    infoAnonymous: "O telemóvel circula anonimamente para as votações.",
    passPhone: "Passe o telemóvel a cada participante para a votação.",
    startVoting: "Iniciar Votação Anónima",
    participant: "Responda em segredo",
    acceptQuestion: "Aceita este desafio?",
    acceptBtn: "✓ Aceitar",
    refuseBtn: "✗ Recusar",
    challengeAccepted: "🎉 DESAFIO ACEITE! 🎉",
    allAgree: "Todos concordaram.",
    challengeRefused: "DESAFIO RECUSADO",
    someoneRefused: "Pelo menos uma pessoa recusou.",
    consentNeeded: "É necessário o consentimento de todos.",
    challengeToComplete: "Desafio a realizar:",
    nextChallenge: "Próximo Desafio",
    newGame: "Novo Jogo",
    infoConsent: "O consentimento pode ser retirado a qualquer momento.",
    selectIntensity: "Por favor, escolha uma intensidade para começar!",
    minPlayers: "São necessários pelo menos 2 participantes!",
    selectProt: "Selecionar Protagonistas",
    selectionInstr: "Coloquem os dedos no ecrã!",
    selectionInstrInProgress: "Mantenham os dedos no sítio...",
    selectProtagonistOf: "A selecionar o protagonista {current} de {total}",
    selectNextProt: "Selecionar o Próximo",
    continue: "Continuar",
    minPlayersForSelection: "É necessário pelo menos 1 dedo no ecrã!",
    selectAnotherProtagonist: "Outro Protagonista",
    continueToNextChallenge: "Próximo Desafio"
  }
};
const challenges = {
  soft: {
    fr:[{t:"Faire un compliment sincère à chaque personne.",n:0},{t:"Le groupe doit créer une chorégraphie de 15 secondes.",n:0},{t:"Masser les épaules de la personne à sa gauche pendant 30 secondes.",n:2}],
    en:[{t:"Give a sincere compliment to each person.",n:0},{t:"The group must create a 15-second choreography.",n:0},{t:"Massage the shoulders of the person on your left for 30 seconds.",n:2}],
    pt:[{t:"Faça um elogio sincero a cada pessoa.",n:0},{t:"O grupo deve criar uma coreografia de 15 segundos.",n:0},{t:"Massaje os ombros da pessoa à sua esquerda durante 30 segundos.",n:2}]
  },
  medium: {
    fr:[{t:"Échanger un baiser sur la joue avec la personne en face.",n:2},{t:"Raconter une anecdote personnelle un peu embarrassante.",n:1},{t:"Échanger un regard intense de 10 secondes avec la personne à sa droite.",n:2}],
    en:[{t:"Exchange a kiss on the cheek with the person opposite you.",n:2},{t:"Tell a slightly embarrassing personal anecdote.",n:1},{t:"Exchange an intense 10-second gaze with the person on your right.",n:2}],
    pt:[{t:"Troque um beijo na bochecha com a pessoa à sua frente.",n:2},{t:"Conte uma anedota pessoal um pouco embaraçosa.",n:1},{t:"Troque um olhar intenso de 10 segundos com a pessoa à sua direita.",n:2}]
  },
  hot: {
    fr:[{t:"Chuchoter une phrase séduisante à l'oreille de la personne de son choix.",n:2},{t:"Partager un fantasme (en restant respectueux).",n:1},{t:"Réaliser une danse sensuelle de 30 secondes à deux.",n:2}],
    en:[{t:"Whisper a seductive phrase in the ear of the person of your choice.",n:2},{t:"Share a fantasy (while remaining respectful).",n:1},{t:"Perform a 30-second sensual dance with a partner.",n:2}],
    pt:[{t:"Sussurre uma frase sedutora ao ouvido da pessoa à sua escolha.",n:2},{t:"Partilhe uma fantasia (mantendo o respeito).",n:1},{t:"Faça uma dança sensual de 30 segundos com um parceiro.",n:2}]
  }
};
// --- FONCTIONS PRINCIPALES DU JEU ---
function selectLanguage(lang) {
  selectedLanguage = lang;
  document.querySelectorAll('.language-option').forEach(opt=>opt.classList.toggle('selected', opt.dataset.lang === lang));
  updateInterface();
}
function updateInterface() {
  const t = translations[selectedLanguage];
  document.getElementById('mainTitle').textContent = t.title;
  document.getElementById('warningText').textContent = t.warning;
  document.getElementById('intensityLabel').textContent = t.intensityLabel;
  document.getElementById('intensitySoftName').textContent = t.intensitySoft;
  document.getElementById('intensityMediumName').textContent = t.intensityMedium;
  document.getElementById('intensityHotName').textContent = t.intensityHot;
  document.getElementById('playerCountLabel').textContent = t.playerCountLabel;
  document.getElementById('startBtn').textContent = t.startBtn;
  document.getElementById('infoAnonymous').textContent = t.infoAnonymous;
  document.getElementById('passPhoneText').textContent = t.passPhone;
  document.getElementById('startVotingBtn').textContent = t.startVoting;
  document.getElementById('votingInstruction').innerHTML = `<strong>${t.participant}</strong><br>${t.acceptQuestion}`;
  document.getElementById('acceptBtn').textContent = t.acceptBtn;
  document.getElementById('refuseBtn').textContent = t.refuseBtn;
  document.getElementById('nextBtn').textContent = t.nextChallenge;
  document.getElementById('newGameBtn').textContent = t.newGame;
  document.getElementById('infoConsent').textContent = t.infoConsent;
  document.getElementById('selectProtBtn').textContent = t.selectProt;
  selectAnotherProtagonistBtn.textContent = t.selectAnotherProtagonist;
  continueToNextChallengeBtn.textContent = t.continueToNextChallenge;
}
function selectIntensity(level) {
  selectedIntensity = level;
  document.querySelectorAll('.intensity-option').forEach(opt=>opt.classList.toggle('selected', opt.dataset.level === level));
  updateStartButton();
}
function adjustPlayerCount(delta) {
  const input = document.getElementById('playerCount');
  let value = parseInt(input.value) || 2;
  value = Math.max(2, Math.min(20, value + delta));
  input.value = value;
  updateStartButton();
}
function updateStartButton() {
  const startBtn = document.getElementById('startBtn');
  playerCount = parseInt(document.getElementById('playerCount').value) || 2;
  startBtn.disabled = !selectedIntensity || playerCount < 2;
}
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.toggle('active', screen.id === screenId));

    const homeBtn = document.getElementById('homeBtn');
    const selectProtagonistBtn = document.getElementById('selectProtagonistBtn');
    if (screenId === 'setupScreen') {
        homeBtn.style.display = 'none';
        selectProtagonistBtn.style.display = 'none';
    } else {
        homeBtn.style.display = 'flex';
        selectProtagonistBtn.style.display = 'flex';
    }
}
function getRandomChallenge() {
  let challengeList = challenges[selectedIntensity]?.[selectedLanguage] || [];
  if (!challengeList.length) return null;
  let availableChallenges = challengeList.filter(c => !usedChallenges.includes(c.t));
  if (availableChallenges.length === 0) {
    usedChallenges = [];
    availableChallenges = challengeList;
  }
  const challenge = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
  usedChallenges.push(challenge.t);
  return challenge;
}
function startGame() {
  playerCount = parseInt(document.getElementById('playerCount').value);
  if (!selectedIntensity) { alert(translations[selectedLanguage].selectIntensity); return; }
  currentChallenge = getRandomChallenge();
  if (!currentChallenge) return;
  document.getElementById('challengeText').textContent = currentChallenge.t;
  currentVote = 0;
  allAccepted = true;
  showScreen('challengeScreen');
}
function startVoting() {
  currentVote = 0;
  allAccepted = true;
  document.getElementById('voteCounter').textContent = `0 / ${playerCount}`;
  showScreen('votingScreen');
}
function vote(accepted) {
  currentVote++;
  if (!accepted) allAccepted = false;
  document.getElementById('voteCounter').textContent = `${currentVote} / ${playerCount}`;
  if (currentVote >= playerCount) {
    showScreen('resultScreen');
    const resultDisplay = document.getElementById('resultDisplay');
    resultDisplay.className = `result-card ${allAccepted ? 'result-accepted' : 'result-refused'}`;
    resultDisplay.innerHTML = allAccepted
      ? `<h3>${translations[selectedLanguage].challengeAccepted}</h3><p>${translations[selectedLanguage].allAgree}</p><hr style="width:50%;margin:10px auto;border-color:rgba(255,255,255,0.5)"><p><strong>${translations[selectedLanguage].challengeToComplete}</strong><br>${currentChallenge.t}</p>`
      : `<h3>${translations[selectedLanguage].challengeRefused}</h3><p>${translations[selectedLanguage].someoneRefused}</p><p>${translations[selectedLanguage].consentNeeded}</p>`;

    const needsSelection = allAccepted && currentChallenge && currentChallenge.n > 0;
    document.getElementById('selectProtBtn').style.display = needsSelection ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = !needsSelection ? 'block' : 'none';
  }
}
function nextRound() {
  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = null;
  currentChallenge = getRandomChallenge();
  if (!currentChallenge) {
    resetGame();
    return;
  }
  document.getElementById('challengeText').textContent = currentChallenge.t;
  showScreen('challengeScreen');
}
function resetGame() {
  if (countdownTimer) clearInterval(countdownTimer);
  playerCount = 2;
  currentChallenge = null;
  currentVote = 0;
  allAccepted = true;
  selectedIntensity = null;
  usedChallenges = [];
  touches = [];
  countdownTimer = null;
  countdownDisplay = null;
  protagonistsToSelect = 0;
  selectedProtagonists = [];
  document.getElementById('playerCount').value = 2;
  document.querySelectorAll('.intensity-option.selected').forEach(opt=>opt.classList.remove('selected'));
  document.querySelectorAll('.language-option').forEach(opt=>opt.classList.toggle('selected', opt.dataset.lang === selectedLanguage));
  showScreen('setupScreen');
  updateStartButton();
}
// --- LOGIQUE DE SÉLECTION SÉQUENTIELLE ---
function startSelection() {
    protagonistsToSelect = currentChallenge.n;
    selectedProtagonists = [];
    runSingleSelectionRound();
}
function startSelectionFromButton() {
    if (!currentChallenge || currentChallenge.n <= 0) {
        alert(translations[selectedLanguage].minPlayers);
        return;
    }
    startSelection();
}
function runSingleSelectionRound() {
    showScreen('selectionScreen');
    touches = [];
    if (countdownTimer) clearInterval(countdownTimer);
    countdownTimer = null;
    if (countdownDisplay) {
        countdownDisplay.remove();
        countdownDisplay = null;
    }

    const instructionText = translations[selectedLanguage].selectProtagonistOf
        .replace('{current}', selectedProtagonists.length + 1)
        .replace('{total}', protagonistsToSelect);
    document.getElementById('selectionInstruction').textContent = instructionText;

    touchArea.innerHTML = '';
    selectionActionBtnGroup.style.display = 'none';
    touchArea.addEventListener('touchstart', handleTouch, {passive: false});
    touchArea.addEventListener('touchmove', handleTouch, {passive: false});
    touchArea.addEventListener('touchend', handleTouch, {passive: false});
}
function handleTouch(e) {
    e.preventDefault();
    updateTouches(e.touches);
}
function updateTouches(touchList) {
    const rect = touchArea.getBoundingClientRect();
    touches = Array.from(touchList).map((t, i) => ({
        id: t.identifier,
        x: t.clientX - rect.left,
        y: t.clientY - rect.top,
        number: i + 1
    }));
    renderFingers();
    if (touches.length > 0 && !countdownTimer) {
        startSelectionCountdown();
    } else if (touches.length === 0 && countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        if (countdownDisplay) {
            countdownDisplay.remove();
            countdownDisplay = null;
        }
        document.getElementById('selectionInstruction').textContent = translations[selectedLanguage].selectProtagonistOf
            .replace('{current}', selectedProtagonists.length + 1)
            .replace('{total}', protagonistsToSelect);
    }
}
function renderFingers() {
    const countdownHTML = touchArea.querySelector('.countdown-display')?.outerHTML || '';
    touchArea.innerHTML = countdownHTML;
    touches.forEach(t => {
        const finger = document.createElement('div');
        finger.className = 'finger';
        finger.style.left = `${t.x}px`;
        finger.style.top = `${t.y}px`;
        finger.textContent = t.number;
        finger.dataset.id = t.id;
        touchArea.appendChild(finger);
    });
}
function startSelectionCountdown() {
    document.getElementById('selectionInstruction').textContent = translations[selectedLanguage].selectionInstrInProgress;
    let count = 5;
    countdownDisplay = document.createElement('div');
    countdownDisplay.className = 'countdown-display';
    touchArea.appendChild(countdownDisplay);
    countdownTimer = setInterval(() => {
        countdownDisplay.textContent = count;
        count--;
        if (count < 0) {
            clearInterval(countdownTimer);
            countdownTimer = null;
            countdownDisplay.remove();
            countdownDisplay = null;
            selectProtagonist();
        }
    }, 1000);
}
function selectProtagonist() {
    if (touches.length < 1) {
        alert(translations[selectedLanguage].minPlayersForSelection);
        runSingleSelectionRound();
        return;
    }
    touchArea.removeEventListener('touchstart', handleTouch);
    touchArea.removeEventListener('touchmove', handleTouch);
    touchArea.removeEventListener('touchend', handleTouch);
    const winnerIndex = Math.floor(Math.random() * touches.length);
    const winner = touches[winnerIndex];
    selectedProtagonists.push(winner);
    document.querySelectorAll('.finger').forEach(f => {
        const fingerId = parseInt(f.dataset.id);
        f.classList.add(fingerId === winner.id ? 'winner' : 'loser');
    });

    // Si on a sélectionné tous les protagonistes nécessaires
    if (selectedProtagonists.length >= protagonistsToSelect) {
        selectionActionBtnGroup.style.display = 'none';
        nextRound();
        return;
    }

    // Sinon, on propose soit de sélectionner un autre protagoniste, soit de passer à un nouveau défi
    selectAnotherProtagonistBtn.onclick = runSingleSelectionRound;
    continueToNextChallengeBtn.onclick = nextRound;
    selectAnotherProtagonistBtn.style.display = 'block';
    continueToNextChallengeBtn.style.display = 'block';
    selectionActionBtnGroup.style.display = 'flex';
}
// --- INITIALISATION DU JEU ---
document.addEventListener('DOMContentLoaded', () => {
    selectLanguage('fr');
    updateStartButton();
});
</script>
</body>
</html>
